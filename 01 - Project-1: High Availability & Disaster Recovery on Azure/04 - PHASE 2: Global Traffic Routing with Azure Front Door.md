# PHASE 2: Global Traffic Routing with Azure Front Door

Is phase mein hum Azure cloud par Azure Front Door service create karenge, apne app services ko front door ke backend par configure karenge, aur last mein DR drill karenge jisme traffic primary app service pe na jake secondary app service pe jayega, jisko hum ek global url se access karenge.

<br>

**Phase 2 Goal**:

Single global URL create karna jo:
- user ko single endpoint de.
- primary down ho to traffic auto switch ho.
- failover health probe se decide ho.
- zero manual intervention required.

<br>

Maine ye project already complete karke test kar liya hai, jisme maine azure pe app service create karke unme app ko deploy kiya tha. Fir azure pe fornt door service create ki thi jisme ek backend (jisko origin group bhi bolte hain) create kiya tha aur app service us backend mein configure kiya primary aur secondary. Jisme Central India wala app service Primary tha aur South India wala app service Secondary tha.

Ye setup complete hone ke baad main DR Test kiya tha, jisme maine primary app service ko stop kiya, thodi der matlab 1.5 se 2 minute ka wait karke public endpoint acces kiya to traffic secondary (South India) wali app service pe jaane laga tha.

Maine Front Door service terraform ke through create ki thi, lekin is file mein tumko steps bataunga ki kaise front door create karna hai.

<br>
<br>

### Create Front Door Service on Azure

**STEP 1: Front Door create (Portal)**:

Portal â†’ Front Door and CDN profiles.

Choose:
- Azure Front Door (Classic learning ke liye ok).
- Tier: Standard.

Name: ```afd-ha-dr```.

RG: ```rg-ha-dr-primary```.

<br>

**STEP 2: Backend Pool (Origin Group)**:

Backend Pool Name: ```ha-dr-backend-pool```.

Backends (Origins):

| Backend   | Hostname                              | Priority |
| --------- | ------------------------------------- | -------- |
| Primary   | ha-dr-app-primary.azurewebsites.net   | 1        |
| Secondary | ha-dr-app-secondary.azurewebsites.net | 2        |

Priority rule:
- Lower number = higher priority.

Priority ka matlab hai ki jitna chota number utni high priority. Front Door high priority pe traffic pehle bhejta hai.

<br>

**STEP 3: Health Probe Setup (MOST IMPORTANT)**:

Health Probe Settings

| Setting            | Value      |
| ------------------ | ---------- |
| Protocol           | HTTPS      |
| Path               | /health    |
| Interval           | 30 seconds |
| Sample Size        | 4          |
| Successful Samples | 3          |

Agar Primary 3 baar fail hua â†’ traffic secondary pe shift ho jayega.

Explanation:
- Protocol: Protocal ka matlab hai ki backend traffic HTTPS par receive kar rha hai.
- Path: Path ka matlab hai ki front door ```/health``` ko hit karke hi pta kar payega ki app service running hai ya nhi.
- Interval: Interval ka matlab hai ki front door har 30 seconds bar backend yaani app service ki health check karega.
- Sample Size: Sample Size ka matlab hai ki front door application ka ```/health``` endpoint 4 baar hit karega har 30 seconds par.
- Successful Samples: Iska matlab hai ki agar ```/health``` endpoint 4 baad hit karne par agar 3 baar 200 response milta hai hai application se to application up and running mana jayega. Agar 3 se kam successful samples milte hain to application up and running nhi maana jayega. To front door traffic ko secondary app service ke shift kar dega.

Meaning:
- Agar 4 samples me se 3 fail â†’ backend unhealthy â†’ traffic shift.

<br>

**STEP 4: Routing Rule**:

Routing Rule Azure Front Door ka sabse core part hai jo yeh decide karta hai ki jab koi user aapke Front Door ke URL ko hit karega, toh us traffic ko backend (aapki App Services) tak kaise pahunchana hai.

Rule name: ```route-all-traffic```:
- Accepted protocols: HTTP + HTTPS.
- Forwarding protocol: HTTPS only.
- Patterns: ```/*```.
- Backend pool: ```ha-dr-backend-pool```.

Explanation:
- Rule Name: ```route-all-traffic```: Ye routing rule ka naam hota hai.
- Accepted Protocols: HTTP + HTTPS:
  - Iska matlab hai ki aapka Front Door dono tarah ke users ko allow karega:
    - Jo ```http://your-app.com``` par aa rahe hain.
    - Jo ```https://your-app.com``` par aa rahe hain. Yeh flexible connectivity ke liye rakha jata hai.
 
- Forwarding Protocol: HTTPS Only:
  - Yeh ek Security Best Practice hai. Iska matlab hai ki chahe user HTTP par aaye, lekin jab Front Door us request ko aapke backend (Central/South India App Services) tak bhejega, toh woh hamesha HTTPS (encrypted) ka hi use karega. Isse aapka backend server (Flask app) hamesha secure rehta hai.

- Patterns: ```/*```:
  - Yeh ek Wildcard Pattern hai.
    - ```/``` ka matlab hai Root (home page).
    - ``*``` ka matlab hai "sab kuch". Mere domain ke piche kuch bhi likha ho (any path), use isi Backend Pool par bhej do.
   
<br>

**STEP 5: Global Endpoint**:

Front Door apko ek auto endpoint deta hai: ```https://afd-ha-dr.azurefd.net```.

Ab users same URL use karenge.

<br>

**STEP 6: Normal Test**:

Browser mein open karo:
```
https://afd-ha-dr.azurefd.net/
```

Expected Response:
```
{
  "message": "HA-DR Application is running",
  "region": "Central India (Primary)",
  "hostname": "..."
}
```

Matlab front door se traffic primary region pe ja rha hai.

<br>

**STEP 7: REAL FAILOVER TEST (DR Drill)**:

Simulate Outage:

Primary App Service stop karo:
```
az webapp stop \
  --name ha-dr-app-primary-<name> \
  --resource-group rg-ha-dr-primary
```

Aap portal se manually bhi primary app service ko stop kar sakte ho.

Wait: 1â€“2 minutes

Front Door Test:

Reload:
```
https://afd-ha-dr.azurefd.net/
```

Expected:
```
{
  "region": "South India (DR)"
}
```

ðŸŽ‰ AUTO FAILOVER SUCCESSFUL!!!


Bring Primary Back:

Ab primary app service ko start kar do.
```
az webapp start \
  --name ha-dr-app-primary-<name> \
  --resource-group rg-ha-dr-primary
```

Aap manually bhi app service ko start kar sakte ho.

Traffic automatically primary pe wapas aa jayega.

<br>

**Measure RTO (Recovery Time Objective) (IMPORTANT)**:

RTO ka matlab hai ki application kiten time tak down rha tha matlab front door ne kitna time liya the service ko continue karne mein. 

Matlab ek application mein maximum kitna downtime ho skta hai.

App stop â†’ traffic switch â‰ˆ 90â€“120 seconds.

Mere case 1.5 se 2 minute baad application up ho gya tha.

<br>
<br>

### Note

Is phase tak humne ek real disaster recovery drill complete kiya hai. Humne dekha ki application kaise deploy karte hain, Highly Available aur Disaster Recovery system kaise setup karte hain, Real time mein ye system kaise work karta hai. Ye sab humne ab dekh liya hai.


<br>
<br>

### Ab PHASE 3 mein hum Database Replication karenge aur DR Drill karenge
